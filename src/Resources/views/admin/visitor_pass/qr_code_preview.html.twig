{# 访客通行证二维码预览模板 #}
{# 此模板专门用于在详情页面展示二维码及相关操作 #}

{% set pass = entity.instance %}

<div class="qr-code-preview-wrapper">
    {# 二维码展示卡片 #}
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-gradient-primary text-white">
            <h5 class="mb-0 d-flex align-items-center">
                <i class="fa fa-qrcode me-2"></i>
                <span>通行证二维码</span>
                {% if pass.isUsed %}
                    <span class="badge bg-light text-dark ms-auto">已使用</span>
                {% elseif pass.validEndTime < date() %}
                    <span class="badge bg-danger ms-auto">已过期</span>
                {% elseif pass.validStartTime > date() %}
                    <span class="badge bg-info ms-auto">未生效</span>
                {% else %}
                    <span class="badge bg-success ms-auto">有效</span>
                {% endif %}
            </h5>
        </div>

        <div class="card-body">
            {% if pass.qrCode %}
                {# 二维码显示区域 #}
                <div class="qr-code-display-section text-center mb-4">
                    <div class="qr-code-frame">
                        {% if pass.qrCode starts with 'data:image' %}
                            {# Base64 编码的图片 #}
                            <img src="{{ pass.qrCode }}"
                                 alt="通行证二维码 - {{ pass.passCode }}"
                                 class="qr-code-img"
                                 id="qrCodeImage">
                        {% elseif pass.qrCode starts with 'http' %}
                            {# URL 地址 #}
                            <img src="{{ pass.qrCode }}"
                                 alt="通行证二维码 - {{ pass.passCode }}"
                                 class="qr-code-img"
                                 id="qrCodeImage">
                        {% else %}
                            {# 纯文本内容，显示为可扫码的内容 #}
                            <div class="qr-code-text-content">
                                <div class="alert alert-light border mb-3">
                                    <div class="text-muted mb-2 small">二维码内容：</div>
                                    <code class="text-dark d-block text-break">{{ pass.qrCode }}</code>
                                </div>
                                <p class="text-muted small mb-0">
                                    <i class="fa fa-info-circle me-1"></i>
                                    请使用前台扫码设备扫描此内容进行核验
                                </p>
                            </div>
                        {% endif %}
                    </div>

                    {# 通行码显示 #}
                    <div class="pass-code-display mt-3">
                        <div class="text-muted small mb-1">通行码</div>
                        <div class="pass-code-value">
                            <span class="badge bg-dark fs-5 px-4 py-2 font-monospace" id="passCodeValue">
                                {{ pass.passCode }}
                            </span>
                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary ms-2"
                                    onclick="copyToClipboard('{{ pass.passCode }}', '通行码')"
                                    title="复制通行码">
                                <i class="fa fa-copy"></i>
                            </button>
                        </div>
                    </div>
                </div>

                {# 有效期信息 #}
                <div class="validity-info-section mb-4">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="info-card">
                                <div class="info-label">
                                    <i class="fa fa-calendar-check text-success me-1"></i>
                                    有效开始
                                </div>
                                <div class="info-value">
                                    {{ pass.validStartTime|date('Y-m-d H:i:s') }}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="info-card">
                                <div class="info-label">
                                    <i class="fa fa-calendar-times text-danger me-1"></i>
                                    有效结束
                                </div>
                                <div class="info-value">
                                    {{ pass.validEndTime|date('Y-m-d H:i:s') }}
                                </div>
                            </div>
                        </div>
                    </div>

                    {# 状态提示 #}
                    <div class="mt-3">
                        {% set now = date() %}
                        {% if pass.isUsed %}
                            <div class="alert alert-success border-start border-4 border-success mb-0">
                                <div class="d-flex align-items-center">
                                    <i class="fa fa-check-circle fa-2x me-3"></i>
                                    <div>
                                        <strong>已使用</strong>
                                        <div class="small text-muted">
                                            使用时间：{{ pass.useTime|date('Y-m-d H:i:s') }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% elseif pass.validEndTime < now %}
                            <div class="alert alert-danger border-start border-4 border-danger mb-0">
                                <div class="d-flex align-items-center">
                                    <i class="fa fa-times-circle fa-2x me-3"></i>
                                    <div>
                                        <strong>已过期</strong>
                                        <div class="small">此通行证无法用于签到，请重新生成通行证</div>
                                    </div>
                                </div>
                            </div>
                        {% elseif pass.validStartTime > now %}
                            <div class="alert alert-info border-start border-4 border-info mb-0">
                                <div class="d-flex align-items-center">
                                    <i class="fa fa-clock fa-2x me-3"></i>
                                    <div>
                                        <strong>未生效</strong>
                                        <div class="small">将于 {{ pass.validStartTime|date('Y-m-d H:i:s') }} 开始生效</div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="alert alert-success border-start border-4 border-success mb-0">
                                <div class="d-flex align-items-center">
                                    <i class="fa fa-check-circle fa-2x me-3"></i>
                                    <div>
                                        <strong>通行证有效</strong>
                                        <div class="small">访客可使用此二维码在有效期内完成签到</div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                {# 操作按钮组 #}
                <div class="action-buttons-section">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <button type="button"
                                    class="btn btn-primary w-100"
                                    onclick="printQRCode()"
                                    {% if pass.isUsed or pass.validEndTime < date() %}disabled{% endif %}>
                                <i class="fa fa-print me-2"></i>打印二维码
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button"
                                    class="btn btn-success w-100"
                                    onclick="downloadQRCode('{{ pass.passCode }}')"
                                    {% if not (pass.qrCode starts with 'data:image' or pass.qrCode starts with 'http') %}disabled{% endif %}>
                                <i class="fa fa-download me-2"></i>下载二维码
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button"
                                    class="btn btn-info w-100"
                                    onclick="shareQRCode()">
                                <i class="fa fa-share-alt me-2"></i>分享二维码
                            </button>
                        </div>
                    </div>
                </div>

                {# 使用说明 #}
                <div class="usage-instructions-section mt-4">
                    <div class="card bg-light border-0">
                        <div class="card-body">
                            <h6 class="card-title text-primary mb-3">
                                <i class="fa fa-info-circle me-2"></i>使用说明
                            </h6>
                            <ol class="mb-0 small">
                                <li class="mb-2">
                                    <strong>展示二维码：</strong>访客到达时，向前台工作人员展示此二维码
                                </li>
                                <li class="mb-2">
                                    <strong>扫码核验：</strong>前台使用扫码设备扫描，系统自动验证有效性
                                </li>
                                <li class="mb-2">
                                    <strong>单次使用：</strong>每个通行证仅可使用一次，使用后自动失效
                                </li>
                                <li class="mb-2">
                                    <strong>有效期限：</strong>请在有效期内使用，过期后需重新申请
                                </li>
                                <li class="mb-0">
                                    <strong>安全提示：</strong>请勿将二维码转发给他人，以免被冒用
                                </li>
                            </ol>
                        </div>
                    </div>
                </div>

            {% else %}
                {# 未生成二维码的情况 #}
                <div class="no-qrcode-section text-center py-5">
                    <div class="mb-4">
                        <i class="fa fa-qrcode fa-4x text-muted"></i>
                    </div>
                    <h5 class="text-muted mb-3">未生成二维码</h5>
                    <p class="text-muted mb-4">
                        此通行证还未生成二维码内容，请联系管理员处理
                    </p>
                    <button type="button" class="btn btn-primary" onclick="generateQRCode()">
                        <i class="fa fa-cog me-2"></i>生成二维码
                    </button>
                </div>
            {% endif %}
        </div>
    </div>
</div>

{# 自定义样式 #}
<style>
    /* 二维码预览容器 */
    .qr-code-preview-wrapper {
        margin: 1rem 0;
    }

    /* 渐变背景 */
    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    /* 二维码框架 */
    .qr-code-frame {
        display: inline-block;
        padding: 2rem;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        border-radius: 1rem;
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.15);
    }

    /* 二维码图片 */
    .qr-code-img {
        max-width: 280px;
        max-height: 280px;
        width: 100%;
        height: auto;
        border: 6px solid white;
        border-radius: 0.75rem;
        box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.1);
        background: white;
    }

    /* 二维码文本内容 */
    .qr-code-text-content {
        max-width: 400px;
        margin: 0 auto;
    }

    /* 通行码显示 */
    .pass-code-display {
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
    }

    .pass-code-value .badge {
        font-size: 1.1rem;
        letter-spacing: 3px;
        font-weight: 600;
    }

    /* 信息卡片 */
    .info-card {
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        border-left: 4px solid #6c757d;
    }

    .info-label {
        font-size: 0.875rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
    }

    .info-value {
        font-size: 1rem;
        font-weight: 600;
        color: #212529;
    }

    /* 警告框增强 */
    .qr-code-preview-wrapper .alert {
        border-radius: 0.5rem;
    }

    /* 按钮样式 */
    .action-buttons-section .btn {
        padding: 0.75rem 1rem;
        font-weight: 500;
    }

    .action-buttons-section .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* 使用说明样式 */
    .usage-instructions-section .card {
        border-radius: 0.5rem;
    }

    .usage-instructions-section ol li {
        line-height: 1.6;
    }

    /* 未生成二维码区域 */
    .no-qrcode-section {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
        .qr-code-frame {
            padding: 1.5rem;
        }

        .qr-code-img {
            max-width: 220px;
            max-height: 220px;
        }

        .pass-code-value .badge {
            font-size: 0.9rem;
            letter-spacing: 2px;
        }
    }

    /* 打印样式 */
    @media print {
        .qr-code-preview-wrapper .card-header,
        .action-buttons-section,
        .usage-instructions-section {
            display: none !important;
        }

        .qr-code-frame {
            box-shadow: none;
            background: white;
        }

        .qr-code-preview-wrapper .card {
            border: none;
            box-shadow: none;
        }

        .validity-info-section {
            page-break-before: avoid;
        }
    }
</style>

{# JavaScript 功能 #}
<script>
    // 复制到剪贴板
    function copyToClipboard(text, label) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function() {
                showToast('success', label + ' 已复制到剪贴板');
            }, function(err) {
                console.error('复制失败:', err);
                fallbackCopyToClipboard(text, label);
            });
        } else {
            fallbackCopyToClipboard(text, label);
        }
    }

    // 兼容性复制方法
    function fallbackCopyToClipboard(text, label) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();

        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showToast('success', label + ' 已复制到剪贴板');
            } else {
                showToast('error', '复制失败，请手动复制');
            }
        } catch (err) {
            console.error('复制失败:', err);
            showToast('error', '复制失败，请手动复制');
        }

        document.body.removeChild(textArea);
    }

    // 打印二维码
    function printQRCode() {
        window.print();
    }

    // 下载二维码
    function downloadQRCode(passCode) {
        const qrCodeImage = document.getElementById('qrCodeImage');
        if (!qrCodeImage) {
            showToast('error', '未找到二维码图片');
            return;
        }

        try {
            const link = document.createElement('a');
            link.href = qrCodeImage.src;
            link.download = '访客通行证_' + passCode + '.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showToast('success', '二维码下载成功');
        } catch (err) {
            console.error('下载失败:', err);
            showToast('error', '下载失败，请重试');
        }
    }

    // 分享二维码
    function shareQRCode() {
        const qrCodeImage = document.getElementById('qrCodeImage');
        const passCodeValue = document.getElementById('passCodeValue');

        if (!qrCodeImage || !passCodeValue) {
            showToast('error', '未找到二维码信息');
            return;
        }

        const shareText = '访客通行证\n通行码: ' + passCodeValue.textContent.trim();

        // 检查是否支持 Web Share API
        if (navigator.share) {
            // 如果是 data URL，尝试转换为 Blob 并分享
            if (qrCodeImage.src.startsWith('data:image')) {
                fetch(qrCodeImage.src)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], 'qrcode.png', { type: 'image/png' });
                        navigator.share({
                            title: '访客通行证',
                            text: shareText,
                            files: [file]
                        }).catch(err => {
                            console.log('分享取消或失败:', err);
                        });
                    })
                    .catch(err => {
                        console.error('转换图片失败:', err);
                        // 降级为仅分享文本
                        navigator.share({
                            title: '访客通行证',
                            text: shareText
                        }).catch(e => console.log('分享取消或失败:', e));
                    });
            } else {
                navigator.share({
                    title: '访客通行证',
                    text: shareText,
                    url: qrCodeImage.src
                }).catch(err => {
                    console.log('分享取消或失败:', err);
                });
            }
        } else {
            // 不支持 Web Share API，复制文本到剪贴板
            copyToClipboard(shareText, '分享内容');
        }
    }

    // 生成二维码（需要后端接口支持）
    function generateQRCode() {
        showToast('info', '正在生成二维码，请稍候...');
        // 这里应该调用后端 API 生成二维码
        // 示例：
        // fetch('/api/visitor-pass/generate-qr', { method: 'POST' })
        //     .then(response => response.json())
        //     .then(data => {
        //         if (data.success) {
        //             location.reload();
        //         } else {
        //             showToast('error', '生成失败: ' + data.message);
        //         }
        //     });
    }

    // 显示提示消息
    function showToast(type, message) {
        // 尝试使用 EasyAdmin 的通知系统
        if (typeof Swal !== 'undefined') {
            Swal.fire({
                icon: type === 'success' ? 'success' : type === 'error' ? 'error' : 'info',
                title: message,
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000,
                timerProgressBar: true
            });
        } else {
            // 降级为 alert
            alert(message);
        }
    }
</script>
