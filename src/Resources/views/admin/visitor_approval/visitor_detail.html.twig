{# 访客审批详情页面模板 #}
{% extends '@EasyAdmin/crud/detail.html.twig' %}

{# 自定义页面标题 #}
{% block content_title %}
    访客审批详情 - {{ entity.instance.visitor.name }}
{% endblock %}

{# 主要内容区域 #}
{% block main %}
    <div class="visitor-approval-detail-wrapper">
        {# 审批状态总览卡片 #}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fa fa-check-circle me-2"></i>审批状态总览
                </h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-3 mb-3">
                        <div class="field-group text-center">
                            <div class="field-label text-muted mb-2">当前状态</div>
                            <div class="field-value">
                                {% set status = entity.instance.status %}
                                {% set badgeClass = 'secondary' %}
                                {% set iconClass = 'fa-clock' %}
                                {% if status.value == 'pending' %}
                                    {% set badgeClass = 'warning' %}
                                    {% set iconClass = 'fa-clock' %}
                                {% elseif status.value == 'approved' %}
                                    {% set badgeClass = 'success' %}
                                    {% set iconClass = 'fa-check-circle' %}
                                {% elseif status.value == 'rejected' %}
                                    {% set badgeClass = 'danger' %}
                                    {% set iconClass = 'fa-times-circle' %}
                                {% endif %}
                                <h3 class="mb-0">
                                    <span class="badge bg-{{ badgeClass }} status-badge">
                                        <i class="fa {{ iconClass }} me-1"></i>{{ status.label }}
                                    </span>
                                </h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="field-group text-center">
                            <div class="field-label text-muted">审批人ID</div>
                            <div class="field-value">
                                {% if entity.instance.approver %}
                                    <span class="badge bg-info">{{ entity.instance.approver }}</span>
                                {% else %}
                                    <span class="text-muted">--</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="field-group text-center">
                            <div class="field-label text-muted">审批时间</div>
                            <div class="field-value">
                                {% if entity.instance.approveTime %}
                                    <i class="fa fa-calendar-check me-1 text-success"></i>
                                    {{ entity.instance.approveTime|date('Y-m-d H:i:s') }}
                                {% else %}
                                    <span class="text-muted">待审批</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="field-group text-center">
                            <div class="field-label text-muted">提交时间</div>
                            <div class="field-value">
                                <i class="fa fa-clock me-1 text-info"></i>
                                {{ entity.instance.createTime|date('Y-m-d H:i:s') }}
                            </div>
                        </div>
                    </div>
                </div>

                {# 审批操作按钮说明区域 #}
                {% if entity.instance.status.value == 'pending' %}
                    <div class="alert alert-info mb-0 mt-3">
                        <i class="fa fa-info-circle me-2"></i>
                        <strong>操作提示：</strong>
                        此审批当前处于待审批状态。可通过以下操作进行审批：
                        <ul class="mb-0 mt-2">
                            <li><strong>通过审批：</strong>调用 VisitorApprovalService::approve() 方法或通过管理后台操作</li>
                            <li><strong>拒绝审批：</strong>调用 VisitorApprovalService::reject() 方法并填写拒绝原因</li>
                        </ul>
                    </div>
                {% endif %}
            </div>
        </div>

        {# 审批详细信息卡片 #}
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">
                    <i class="fa fa-clipboard-list me-2"></i>审批详细信息
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-hover table-bordered approval-info-table">
                    <tbody>
                        <tr>
                            <th class="table-label" width="200">审批ID</th>
                            <td>{{ entity.instance.id }}</td>
                        </tr>
                        <tr>
                            <th class="table-label">审批状态</th>
                            <td>
                                {% set status = entity.instance.status %}
                                {% set badgeClass = 'secondary' %}
                                {% if status.value == 'pending' %}
                                    {% set badgeClass = 'warning' %}
                                {% elseif status.value == 'approved' %}
                                    {% set badgeClass = 'success' %}
                                {% elseif status.value == 'rejected' %}
                                    {% set badgeClass = 'danger' %}
                                {% endif %}
                                <span class="badge bg-{{ badgeClass }}">{{ status.label }}</span>
                                <span class="text-muted ms-2">({{ status.value }})</span>
                            </td>
                        </tr>
                        <tr>
                            <th class="table-label">审批人ID</th>
                            <td>
                                {% if entity.instance.approver %}
                                    <span class="badge bg-info">{{ entity.instance.approver }}</span>
                                {% else %}
                                    <span class="text-muted">未指定</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th class="table-label">审批时间</th>
                            <td>
                                {% if entity.instance.approveTime %}
                                    <i class="fa fa-calendar-check me-1 text-success"></i>
                                    {{ entity.instance.approveTime|date('Y-m-d H:i:s') }}
                                {% else %}
                                    <span class="text-muted">尚未审批</span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th class="table-label">创建时间</th>
                            <td>
                                <i class="fa fa-clock me-1 text-info"></i>
                                {{ entity.instance.createTime|date('Y-m-d H:i:s') }}
                            </td>
                        </tr>
                        <tr>
                            <th class="table-label">审批备注 / 拒绝原因</th>
                            <td>
                                {% if entity.instance.rejectReason %}
                                    <div class="alert alert-danger mb-0 p-2">
                                        <i class="fa fa-exclamation-triangle me-1"></i>
                                        <strong>拒绝原因：</strong>
                                        <p class="mb-0 mt-1">{{ entity.instance.rejectReason }}</p>
                                    </div>
                                {% else %}
                                    <span class="text-muted">无</span>
                                {% endif %}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        {# 关联访客信息卡片 #}
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fa fa-user me-2"></i>关联访客信息
                </h5>
            </div>
            <div class="card-body">
                {% set visitor = entity.instance.visitor %}
                {% if visitor %}
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="field-group">
                                <div class="field-label text-muted">访客姓名</div>
                                <div class="field-value fw-bold">{{ visitor.name }}</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="field-group">
                                <div class="field-label text-muted">手机号码</div>
                                <div class="field-value">{{ visitor.mobile }}</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="field-group">
                                <div class="field-label text-muted">公司名称</div>
                                <div class="field-value">{{ visitor.company ?: '未提供' }}</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="field-group">
                                <div class="field-label text-muted">联系人</div>
                                <div class="field-value">{{ visitor.contactPerson ?: '未提供' }}</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="field-group">
                                <div class="field-label text-muted">身份证号</div>
                                <div class="field-value">{{ visitor.idCard ?: '未提供' }}</div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="field-group">
                                <div class="field-label text-muted">访客状态</div>
                                <div class="field-value">
                                    {% set visitorStatus = visitor.status %}
                                    {% set vsBadgeClass = 'secondary' %}
                                    {% if visitorStatus.value == 'pending' %}
                                        {% set vsBadgeClass = 'warning' %}
                                    {% elseif visitorStatus.value == 'approved' %}
                                        {% set vsBadgeClass = 'success' %}
                                    {% elseif visitorStatus.value == 'rejected' %}
                                        {% set vsBadgeClass = 'danger' %}
                                    {% elseif visitorStatus.value == 'signed_in' %}
                                        {% set vsBadgeClass = 'info' %}
                                    {% elseif visitorStatus.value == 'signed_out' %}
                                        {% set vsBadgeClass = 'secondary' %}
                                    {% elseif visitorStatus.value == 'cancelled' %}
                                        {% set vsBadgeClass = 'dark' %}
                                    {% endif %}
                                    <span class="badge bg-{{ vsBadgeClass }}">{{ visitorStatus.label }}</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-12 mb-3">
                            <div class="field-group">
                                <div class="field-label text-muted">来访事由</div>
                                <div class="field-value">{{ visitor.reason }}</div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="field-group">
                                <div class="field-label text-muted">预约时间</div>
                                <div class="field-value">
                                    {% if visitor.appointmentTime %}
                                        {{ visitor.appointmentTime|date('Y-m-d H:i:s') }}
                                    {% else %}
                                        未设置
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="field-group">
                                <div class="field-label text-muted">访客ID</div>
                                <div class="field-value">
                                    <span class="badge bg-secondary">{{ visitor.id }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {# 快捷链接到访客详情 #}
                    <div class="mt-3">
                        <a href="{{ ea_url()
                            .setController('Tourze\\VisitorManageBundle\\Controller\\VisitorCrudController')
                            .setAction('detail')
                            .setEntityId(visitor.id) }}"
                           class="btn btn-sm btn-outline-primary">
                            <i class="fa fa-external-link-alt me-1"></i>查看完整访客信息
                        </a>
                    </div>
                {% else %}
                    <div class="alert alert-warning mb-0">
                        <i class="fa fa-exclamation-triangle me-2"></i>
                        未找到关联访客信息
                    </div>
                {% endif %}
            </div>
        </div>

        {# 审批流程说明卡片 #}
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="fa fa-route me-2"></i>审批流程说明
                </h5>
            </div>
            <div class="card-body">
                <div class="approval-flow">
                    <div class="flow-step">
                        <div class="step-number">1</div>
                        <div class="step-content">
                            <h6 class="step-title">访客提交申请</h6>
                            <p class="step-desc text-muted">访客填写基本信息并提交来访申请，系统自动创建审批记录</p>
                        </div>
                    </div>
                    <div class="flow-arrow">
                        <i class="fa fa-arrow-down"></i>
                    </div>
                    <div class="flow-step {{ entity.instance.status.value == 'pending' ? 'active' : '' }}">
                        <div class="step-number">2</div>
                        <div class="step-content">
                            <h6 class="step-title">待审批</h6>
                            <p class="step-desc text-muted">审批人查看申请详情，判断是否允许来访</p>
                        </div>
                    </div>
                    <div class="flow-arrow">
                        <i class="fa fa-arrow-down"></i>
                    </div>
                    <div class="flow-step {{ entity.instance.status.value in ['approved', 'rejected'] ? 'active' : '' }}">
                        <div class="step-number">3</div>
                        <div class="step-content">
                            <h6 class="step-title">审批完成</h6>
                            <p class="step-desc text-muted">
                                {% if entity.instance.status.value == 'approved' %}
                                    <span class="badge bg-success">已通过</span>
                                    访客可以按预约时间来访
                                {% elseif entity.instance.status.value == 'rejected' %}
                                    <span class="badge bg-danger">已拒绝</span>
                                    访客申请被拒绝
                                {% else %}
                                    审批人做出通过或拒绝决定，系统记录审批结果
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>

                {# 操作方法说明 #}
                <div class="alert alert-light border mt-4 mb-0">
                    <h6 class="alert-heading">
                        <i class="fa fa-code me-2"></i>审批操作方法
                    </h6>
                    <hr>
                    <p class="mb-2"><strong>通过审批：</strong></p>
                    <pre class="bg-dark text-light p-2 rounded mb-3"><code>$visitorApprovalService->approve($approvalId, $approverId);</code></pre>

                    <p class="mb-2"><strong>拒绝审批：</strong></p>
                    <pre class="bg-dark text-light p-2 rounded mb-0"><code>$visitorApprovalService->reject($approvalId, $approverId, $rejectReason);</code></pre>
                </div>
            </div>
        </div>
    </div>

    {# 保留原始的删除表单 #}
    {% block delete_form %}
        {{ include('@EasyAdmin/crud/includes/_delete_form.html.twig', { entity_id: entity.primaryKeyValue }, with_context = false) }}
    {% endblock delete_form %}
{% endblock %}

{# 自定义样式 #}
{% block configured_stylesheets %}
    {{ parent() }}
    <style>
        /* 卡片样式 */
        .visitor-approval-detail-wrapper .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        .visitor-approval-detail-wrapper .card-header {
            border-bottom: none;
            padding: 1rem 1.25rem;
        }
        .visitor-approval-detail-wrapper .card-header h5 {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* 字段组样式 */
        .visitor-approval-detail-wrapper .field-group {
            padding: 0.5rem 0;
        }
        .visitor-approval-detail-wrapper .field-label {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        .visitor-approval-detail-wrapper .field-value {
            font-size: 1rem;
            color: #212529;
        }

        /* 状态徽章样式 */
        .visitor-approval-detail-wrapper .status-badge {
            font-size: 1.2rem;
            padding: 0.5rem 1.25rem;
            border-radius: 0.5rem;
        }
        .visitor-approval-detail-wrapper .badge {
            font-size: 0.875rem;
            padding: 0.375rem 0.75rem;
        }

        /* 表格样式 */
        .visitor-approval-detail-wrapper .approval-info-table {
            margin-bottom: 0;
        }
        .visitor-approval-detail-wrapper .approval-info-table th.table-label {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
            vertical-align: middle;
        }
        .visitor-approval-detail-wrapper .approval-info-table td {
            vertical-align: middle;
        }

        /* 审批流程样式 */
        .visitor-approval-detail-wrapper .approval-flow {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }
        .visitor-approval-detail-wrapper .flow-step {
            display: flex;
            align-items: flex-start;
            width: 100%;
            max-width: 600px;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 0.5rem;
            border-left: 4px solid #6c757d;
            transition: all 0.3s ease;
        }
        .visitor-approval-detail-wrapper .flow-step.active {
            background-color: #e7f3ff;
            border-left-color: #0d6efd;
            box-shadow: 0 0.25rem 0.5rem rgba(13, 110, 253, 0.2);
        }
        .visitor-approval-detail-wrapper .flow-step .step-number {
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #6c757d;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            margin-right: 1rem;
        }
        .visitor-approval-detail-wrapper .flow-step.active .step-number {
            background-color: #0d6efd;
        }
        .visitor-approval-detail-wrapper .flow-step .step-content {
            flex-grow: 1;
        }
        .visitor-approval-detail-wrapper .flow-step .step-title {
            margin-bottom: 0.25rem;
            font-weight: 600;
            color: #212529;
        }
        .visitor-approval-detail-wrapper .flow-step .step-desc {
            margin-bottom: 0;
            font-size: 0.9rem;
        }
        .visitor-approval-detail-wrapper .flow-arrow {
            color: #6c757d;
            font-size: 1.5rem;
            margin: 0.5rem 0;
        }

        /* 代码块样式 */
        .visitor-approval-detail-wrapper pre {
            margin-bottom: 0;
            border-radius: 0.25rem;
        }
        .visitor-approval-detail-wrapper code {
            color: #e83e8c;
            font-size: 0.9rem;
        }
        .visitor-approval-detail-wrapper pre code {
            color: #f8f9fa;
        }

        /* 警告框样式 */
        .visitor-approval-detail-wrapper .alert {
            border-left: 4px solid;
        }
        .visitor-approval-detail-wrapper .alert-info {
            border-left-color: #0dcaf0;
        }
        .visitor-approval-detail-wrapper .alert-warning {
            border-left-color: #ffc107;
        }
        .visitor-approval-detail-wrapper .alert-danger {
            border-left-color: #dc3545;
        }
    </style>
{% endblock %}
